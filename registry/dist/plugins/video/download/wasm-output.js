!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["video/download/wasm-output"]=t():e["video/download/wasm-output"]=t()}(globalThis,(()=>(()=>{"use strict";var e={124:(e,t,o)=>{o.r(t),o.d(t,{default:()=>d});var n=function(){var e=this,t=e._self._c;e._self._setupProxy;return e.shouldShow?t("div",{staticClass:"download-video-config-item",staticStyle:{"flex-wrap":"wrap"}},[t("div",{staticClass:"download-video-config-title"},[e._v("写入元数据：")]),e._v(" "),t("SwitchBox",{on:{change:e.saveOptions},model:{value:e.muxWithMetadata,callback:function(t){e.muxWithMetadata=t},expression:"muxWithMetadata"}}),e._v(" "),t("div",{staticClass:"download-video-config-description",staticStyle:{width:"100%"}},[e._v("\n    仅支持元数据类型「ffmetadata」\n  ")])],1):e._e()};n._withStripped=!0;const a=coreApis.ui;var i=o(986);const{options:s}=(0,i.getComponentSettings)("downloadVideo"),r={muxWithMetadata:!1,...s};var c=function(e,t,o,n,a,i,s,r){var c,d="function"==typeof e?e.options:e;if(t&&(d.render=t,d.staticRenderFns=o,d._compiled=!0),n&&(d.functional=!0),i&&(d._scopeId="data-v-"+i),s?(c=function(e){(e=e||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(e=__VUE_SSR_CONTEXT__),a&&a.call(this,e),e&&e._registeredComponents&&e._registeredComponents.add(s)},d._ssrRegister=c):a&&(c=r?function(){a.call(this,(d.functional?this.parent:this).$root.$options.shadowRoot)}:a),c)if(d.functional){d._injectStyles=c;var l=d.render;d.render=function(e,t){return c.call(t),l(e,t)}}else{var u=d.beforeCreate;d.beforeCreate=u?[].concat(u,c):[c]}return{exports:e,options:d}}(Vue.extend({components:{SwitchBox:a.SwitchBox},data(){const e=(0,i.isComponentEnabled)("saveVideoMetadata");return{shouldShow:e,muxWithMetadata:e&&r.muxWithMetadata}},methods:{saveOptions(){r.muxWithMetadata=this.muxExtraAssets,Object.assign(s,r)}}}),n,[],!1,null,null,null);const d=c.exports},986:e=>{e.exports=coreApis.settings}},t={};function o(n){var a=t[n];if(void 0!==a)return a.exports;var i=t[n]={exports:{}};return e[n](i,i.exports,o),i.exports}o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};return(()=>{o.d(n,{plugin:()=>C,T:()=>M});const e=coreApis.toast,t=coreApis.download,a=coreApis.meta;var i=o(986);function s(e,t,o){return(t=function(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var o=e[Symbol.toPrimitive];if(void 0!==o){var n=o.call(e,t||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function r(e,t,o){!function(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}(e,t),t.set(e,o)}function c(e,t,o){return function(e,t,o){if(t.set)t.set.call(e,o);else{if(!t.writable)throw new TypeError("attempted to set read only private field");t.value=o}}(e,l(e,t,"set"),o),o}function d(e,t){return function(e,t){if(t.get)return t.get.call(e);return t.value}
/* eslint-disable @typescript-eslint/naming-convention */(e,l(e,t,"get"))}function l(e,t,o){if(!t.has(e))throw new TypeError("attempted to "+o+" private field on non-instance");return t.get(e)}const u=(()=>{let e=0;return()=>e++})();var p=function(e){return e.LOAD="LOAD",e.EXEC="EXEC",e.WRITE_FILE="WRITE_FILE",e.READ_FILE="READ_FILE",e.ERROR="ERROR",e}(p||{}),f=new WeakMap,h=new WeakMap,m=new WeakMap,w=new WeakMap,v=new WeakMap;const g=coreApis.utils.formatters,y={cache:"cache"};async function b(e,t){return async function(){return new Promise(((e,t)=>{const o=unsafeWindow.indexedDB.open("bilibili-evolved-wasm-output",124);o.onerror=t,o.onupgradeneeded=()=>{const e=o.result;for(const t of e.objectStoreNames)e.deleteObjectStore(t);Object.values(y).forEach((t=>{e.createObjectStore(t)}))},o.onsuccess=()=>e(o.result)}))}().then((o=>new Promise(((n,a)=>{const i=o.transaction(e,t);n(i.objectStore(e)),i.onerror=a}))))}async function E(e,t,o){const n=await b(e).then((e=>async function(e,t){return new Promise(((o,n)=>{const a=e.get(t);a.onerror=n,a.onsuccess=()=>o(a.result)}))}(e,t)));if(n)return n;const a=await o(t);return await b(e,"readwrite").then((e=>async function(e,t,o){return new Promise(((n,a)=>{const i=e.put(t,o);i.onerror=a,i.onsuccess=()=>n(i.result)}))}(e,a,t))),a}function x(e){const t=[];return(o,n)=>(a,i)=>{var s,r;t[o]=`${n}: ${s=a,r=i,`${(0,g.formatFileSize)(s)}${r>0?` / ${(0,g.formatFileSize)(r)} @ ${(0,g.formatPercent)(s/r)}`:""}`}`,e.message=t.join("\n")}}async function _(e,t){const o=await fetch(e);if(!o.ok)throw new Error(`${o.status} ${o.statusText}`);const n=o.body.getReader(),a=o.headers.get("Content-Encoding")?-1:parseInt(o.headers.get("Content-Length"));let i=0;const s=[];
// eslint-disable-next-line no-constant-condition
for(;;){const{done:e,value:o}=await n.read();if(e)break;s.push(o),i+=o.length,t(i,a)}const r=new Uint8Array(i);let c=0;for(const e of s)r.set(e,c),c+=e.length;return r}async function S(e,t,o){return E(y.cache,e,(async()=>_(t,o)))}function F(e,t){const o=new Blob([e],{type:t});return URL.createObjectURL(o)}const A=new class{constructor(){var e=this;r(this,f,{writable:!0,value:null}),r(this,h,{writable:!0,value:{}}),r(this,m,{writable:!0,value:{}}),s(this,"loaded",!1),r(this,w,{writable:!0,value:()=>{d(this,f)&&(d(this,f).onmessage=e=>{let{data:{id:t,type:o,data:n}}=e;switch(o){case p.LOAD:this.loaded=!0,d(this,h)[t](n);break;case p.EXEC:case p.WRITE_FILE:case p.READ_FILE:d(this,h)[t](n);break;case p.ERROR:d(this,m)[t](n)}delete d(this,h)[t],delete d(this,m)[t]})}}),r(this,v,{writable:!0,value:function(t){let{type:o,data:n}=t,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2?arguments[2]:void 0;return d(e,f)?new Promise(((t,s)=>{const r=u();d(e,f)&&d(e,f).postMessage({id:r,type:o,data:n},a),d(e,h)[r]=t,d(e,m)[r]=s,i?.addEventListener("abort",(()=>{s(new DOMException(`Message # ${r} was aborted`,"AbortError"))}),{once:!0})})):Promise.reject(new Error("FFmpeg is not loaded"))}}),s(this,"load",((e,t)=>(d(this,f)||(c(this,f,new Worker(e.workerLoadURL,{type:"classic"})),d(this,w).call(this)),d(this,v).call(this,{type:p.LOAD,data:e},void 0,t)))),s(this,"exec",(function(t){let o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,n=arguments.length>2?arguments[2]:void 0;return d(e,v).call(e,{type:p.EXEC,data:{args:t,timeout:o}},void 0,n)})),s(this,"terminate",(()=>{const e=Object.keys(d(this,m));for(const t of e)d(this,m)[t](new Error("FFmpeg terminated")),delete d(this,m)[t],delete d(this,h)[t];d(this,f)&&(d(this,f).terminate(),c(this,f,null),this.loaded=!1)})),s(this,"writeFile",((e,t,o)=>{const n=[];return n.push(t.buffer),d(this,v).call(this,{type:p.WRITE_FILE,data:{path:e,data:t}},n,o)})),s(this,"readFile",((e,t)=>d(this,v).call(this,{type:p.READ_FILE,data:{path:e,encoding:"binary"}},void 0,t)))}};async function R(o,n,a,i,s){let r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,c=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1;const d=e.Toast.info("",`${M} - ${r} / ${c}`),l=x(d),[u,p]=await Promise.all([_(n,l(0,"正在下载视频流")),_(a,l(1,"正在下载音频流"))]);A.writeFile("video",u),A.writeFile("audio",p);const f=["-i","video","-i","audio"];i&&(A.writeFile("ffmetadata",(new TextEncoder).encode(i)),f.push("-i","ffmetadata","-map_metadata","2"),s||f.push("-movflags","+use_metadata_tags")),f.push("-codec","copy","-f",s?"matroska":"mp4","output"),console.debug("FFmpeg commandline args:",f.join(" ")),d.message="混流中……",await A.exec(f);const h=await A.readFile("output"),m=new Blob([h],{type:s?"video/x-matroska":"video/mp4"});d.message="完成！",d.duration=1e3,await t.DownloadPackage.single(o.replace(/.[^/.]+$/,"."+(s?"mkv":"mp4")),m)}async function W(t,o){A.loaded||await async function(){const t=e.Toast.info("正在加载 FFmpeg",`${M} - 初始化`),o=x(t),[n,i,s]=await Promise.all([S("ffmpeg-worker",a.meta.compilationInfo.altCdn.library.ffmpeg.worker,o(0,"正在加载 FFmpeg Worker")),S("ffmpeg-core",a.meta.compilationInfo.altCdn.library.ffmpeg.core,o(1,"正在加载 FFmpeg Core")),S("ffmpeg-wasm",a.meta.compilationInfo.altCdn.library.ffmpeg.wasm,o(2,"正在加载 FFmpeg WASM"))]);await A.load({workerLoadURL:F(n,"text/javascript"),coreURL:F(i,"text/javascript"),wasmURL:F(s,"application/wasm")}),t.message="完成！",t.close()}();const{infos:n,extraAssets:s}=t;let r;if(o){const e=[];for(const{asset:t,instance:o}of s)r||"saveVideoMetadata"!==t.name||"ffmetadata"!==o.type?e.push({asset:t,instance:o}):r=await t.getAssets(n,o);t.extraAssets=e}const{dashAudioExtension:c,dashFlacAudioExtension:d,dashVideoExtension:l}=(0,i.getComponentSettings)("downloadVideo").options;for(let e=0;e<n.length;e++){const t=n[e],[o,a]=t.titledFragments;if(2!==t.fragments.length||o.extension!==l||a.extension!==c&&a.extension!==d)throw new Error("仅支持 DASH 格式视频和音频");await R(o.title,o.url,a.url,r?.[e]?.data,a.extension===d,e+1,n.length)}}const M="WASM 混流输出",j="使用 WASM 在浏览器中下载并合并音视频, 支持批量下载",C={name:"downloadVideo.outputs.wasm",displayName:`下载视频 - ${M}`,description:j,author:{name:"WakelessSloth56",link:"https://github.com/WakelessSloth56"},setup:t=>{let{addData:n}=t;n("downloadVideo.outputs",(t=>{t.push({name:"wasm",displayName:"WASM",description:`${j}。运行过程中请勿关闭页面，初次使用或清除缓存后需要加载约 30 MB 的 WASM 文件。`,runAction:async(t,o)=>{try{await W(t,o.muxWithMetadata)}catch(t){e.Toast.error(String(t),M)}},component:()=>Promise.resolve().then(o.bind(o,124)).then((e=>e.default))})}))},commitHash:"49dab167c6a752ded5d6aca0615efb98bcc98884",coreVersion:"2.9.1"}})(),n=n.plugin})()));